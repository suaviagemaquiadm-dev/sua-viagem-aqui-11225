import"./modulepreload-polyfill-B5Qt9EMX.js";import{y as b,z as w,A as C,h as g,i as E,B as P,b as L,C as I,d as B,a as A,D as M}from"./main-DHtEt640.js";import"./layout-Bzk_Fs54.js";import{s as n}from"./alert-CuEEcBcm.js";const T=b(w),v=C(T,"southamerica-east1");let u=null,f=null;async function F(){if(!u)try{if(u=(await g(v,"getFrontendConfig")()).data.mercadoPagoPublicKey,u)f=new MercadoPago(u,{locale:"pt-BR"});else throw new Error("A chave pública do Mercado Pago não foi recebida do servidor.")}catch(t){console.error("Erro ao inicializar o Mercado Pago:",t),n("Não foi possível carregar o sistema de pagamento. Tente novamente mais tarde.","error")}}async function z(t,s,e,a,c){if(await F(),!f){n("O sistema de pagamento não está disponível. Tente mais tarde.","error");return}const i=g(v,"createMercadoPagoPreference");try{const d=(await i({title:t,price:s,userId:e,email:a,transactionType:c})).data.preferenceId;if(d)f.checkout({preference:{id:d},autoOpen:!0});else throw new Error("ID de preferência não recebido.")}catch(r){console.error("Erro ao criar a preferência de pagamento:",r),n("Ocorreu um erro ao iniciar o pagamento. Por favor, tente novamente.","error")}}async function D(t,s={}){try{const a=await g(E,t)(s);if(a.data&&a.data.success===!1)throw new Error(a.data.error||`Function ${t} reported a failure.`);return a.data}catch(e){console.error(`Error calling function '${t}':`,e);const a=e.code==="unauthenticated"?"Você precisa estar logado para realizar esta ação.":"Ocorreu um erro ao comunicar com o servidor. Tente novamente.";throw n(a),e}}document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("form-container"),s=document.getElementById("success-container"),e=document.getElementById("traveler-plus-form"),a=document.getElementById("form-message"),c=document.getElementById("submit-btn"),i=document.getElementById("submit-text"),r=document.getElementById("submit-loading"),d=document.getElementById("control-code-display");e&&e.addEventListener("submit",async h=>{h.preventDefault(),i.classList.add("hidden"),r.classList.remove("hidden"),r.classList.add("flex"),c.disabled=!0,a.classList.add("hidden");const m=e.email.value,y=e.password.value;if(!e.checkValidity()){n("Por favor, preencha todos os campos obrigatórios."),c.disabled=!1,i.classList.remove("hidden"),r.classList.add("hidden");return}try{const o=(await P(L,m,y)).user,p=(await D("generateAndAssignControlCode",{userId:o.uid,userType:"vj"})).controlCode;await I(B(A,"users",o.uid),{name:e.name.value,dob:e.dob.value,gender:e.gender.value,cpf:e.cpf.value,city:e.city.value,state:e.state.value,telegram:e.telegram.value||null,email:m,role:"traveler_plus",payment_status:"pending",controlCode:p,createdAt:M()}),t.classList.add("hidden"),s.classList.remove("hidden"),d.textContent=p,await z("Assinatura Viajante Plus",9.99,o.uid,m,"user_subscription")}catch(l){console.error("Erro no registo Plus:",l);let o="Ocorreu um erro. Tente novamente.";l.code==="auth/email-already-in-use"?o="Este email já está em uso. Tente fazer login ou use outro email.":l.code==="auth/weak-password"&&(o="A senha deve ter pelo menos 6 caracteres."),n(o)}finally{i.classList.remove("hidden"),r.classList.add("hidden"),r.classList.remove("flex"),c.disabled=!1}})});
